---
title: Hugoのテンプレート(ショートコード)の使い方を整理しておく
date: 2023-04-03
tags:
  - hugo
  - blog
thumbnail: golang
featureImage: ./top.jpg

description: このブログはHugoというGo言語製のジェネレータを使っています。記事執筆の効率を上げるためのHugoのテンプレート機能の基本についてまとめてみました。

summary: このブログはHugoというGo言語製のジェネレータを使っています。すでに執筆作業中に冗長さを感じたり後で手直しが発生した場合にあちこち直して回らなければならないだろうな、ということが見えてしまって、モヤモヤしています。効率的な記事執筆のためにHugoのテンプレート機能の使い方についてまとめておくことにします。
---

## Hugoのテンプレートについて

Hugoで使用するテンプレート言語はHugo付属の専用テンプレート言語ではなくGo言語の標準ライブラリであるhtml/templateおよびtext/templateというライブラリが使われています。が、Hugoを使うにあたりGo言語の知識が必要になることはなさそうです(今のところは。おそらく今後もない)。

## この記事で扱う内容

記事を書いている際に不便だなと感じたときに独自のショートコードを定義して解決できるようになることを目指します。実際に記事を執筆している段階で私が欲しいと思っていたショートコードを実装しましたのでそちらも紹介していきます。

{{% notice tip "MEMO" %}}
この記事内で実装するショートコードを実行するためにはextendedバージョンのhugoが必要です
{{% /notice %}}

## テンプレート記法の基本

ショートコードの実装に入る前に前提となる基本知識を押さえておきます。ショートコードはルートディレクトリ下のlayouts/shortcodesに配置します。ショートコード名.htmlという名前でファイルを作成します。例としてhello.htmlというショートコードを作成してみます。

```html
<div style="padding: 5px; border: 1px solid black;">Hello, World!!</div>
```

このショートコードをマークダウン内で`{{</*hello*/>}}`のように記述して使うことができます。なおショートコードの名前(ここではhello)を囲む、左右の開始と終了の3文字の記号はひと続きである必要があります。つまり、

- `{{</*hello*/>}}`
- `{{</*　hello　*/>}}`

上記の二つは正しい記述ですが、

- `{{ <hello> }}`

こちらの記述は不正なので注意しましょう(気づかなくて少しハマりました)。

実際に使った場合、次のように表示されます：

<blockquote>
{{< hello1 >}}
</blockquote>

## 定義済みの変数にアクセスする

テンプレートから`Page`オブジェクトで定義されているプロパティにアクセスしてみます。Pageオブジェクトはその名前の通りページに関する情報を保持しています。
例えばこのページのタイトルを表示してみます。hello.htmlを次のように修正します。

```html
<div style="padding: 5px; border: 1px solid black;">Hello, {{.Page.Title}}!!</div>
```

修正後に再度ショートコードを使うと、次のように表示されます：

<blockquote>
{{< hello2 >}}
</blockquote>

Pageの前についている「.」はコンテキストを表します。マークダウン内でショートコードを記述した場合、
デフォルトのコンテキストとして現在のページのコンテキストが設定されます。
コンテキストからはPageオブジェクトや`Site`オブジェクトにアクセスすることができます。
またPageオブジェクトが持つ`Params`オブジェクトからフロントマターの情報にもアクセスできます。これらの情報にアクセスするようにさらにhello.htmlを修正してみます。

```html
<div style="padding: 5px; border: 1px solid black;">
  Hello, World!!
  <ul>
    <li>Site Title: {{ .Site.Title }}</li>
    <li>Page Title: {{ .Page.Title }}</li>
    <li>Tags: {{ .Page.Params.tags }}</li>
  </ul>
</div>
```

表示してみます：

<blockquote>
{{< hello3 >}}
</blockquote>

コンテキストは切り替えることが可能です。例えば`with`を使うことで任意のオブジェクトをコンテキストとして設定できます。また要素のコレクションを`range`でループする際は、現在対象としている要素がコンテキストに自動で設定されます。実際に確認してみます。hello.htmlを次のように修正します：

```html
<div style="padding: 5px; border: 1px solid black;">
  Hello, World!!
  <ul>
    <li>Site Title: {{ with .Site }}{{ .Title }}{{ end }}</li>
    <li>Page Title: {{ with .Page }}{{ .Title }}{{ end }}</li>
    <li>Tags: {{ range .Page.Params.tags }} {{ . }} {{ end }}</li>
  </ul>
</div>
```

表示してみます：

<blockquote>
{{< hello4 >}}
</blockquote>

ひとつ前の例とほぼ同じ内容が表示されましたが、前回はTagsの配列をそのまま表示していたので、配列を表す角カッコが表示されていたのに対し、
今回のバージョンでは要素をひとつづつ取り出しながら表示しているので角カッコがなくなっているのがわかります。

## ショートコードに引数を渡す

これまで作成したショートコードは呼び出し時にパラメータを渡すことができなかったのでパラメータを渡せるように修正してみます。

```html
<div style="padding: 5px; border: 1px solid black;">Hello, { .Get 0 }!!!</div>
```

まあ見れば意味わかるよね、って内容なので説明は割愛します。使う側では以下のようにパラメータを指定します。

- `{{</* hello "World" */>}}`

表示してみます：

<blockquote>
{{< hello5 "World" >}}
</blockquote>

## 名前付きパラメータを使う

前の例でパラメータの位置番号(0)を指定していた箇所をパラメータ名に変えることで名前付きパラメータを使うことができます。以下のように修正します。

```html
<div style="padding: 5px; border: 1px solid black;">Hello, {{ .Get "name" }}!!!!</div>
```

使う側では以下のようにパラメータを指定します。

- `{{</* hello name="World" */>}}`

表示してみます：

<blockquote>
{{< hello6 name="World" >}}
</blockquote>

{{% notice tip "MEMO" %}}
通常のパラメータと名前付きパラメータを混在して使うことはできませんでした
{{% /notice %}}

## 実践編： 実際に使うショートコードを実装する

次のような使い方をするショートコードを実装します：`{{</* i prefix="1" method="resize" width=512 height=512 */>}}`

`i`はimageの略です。つまりこのショートコードは`<img>`タグを生成します。使用頻度が高いのでなるべく簡単に書けるように1文字にしました。
次の機能を持ちます。

- 引数で指定したプレフィクスと一致する画像ファイルを検索する。
- 任意の方法(resize/crop/fill/fit)で画像を加工する。横幅と縦幅も指定できるようにする。
- フォーマットを変換して画質も落とす(webpフォーマットのq50)

以降、引数の解説です。

### prefix

prefixは画像ファイルパスのプレフィクスを指定します。記事と同じ階層にある複数の画像ファイルの中からプレフィクスが一致するファイルを選択し、
その画像のパスをimgタグのsrcに設定するようにします。プレフィクスが一致する画像ファイルは必ずひとつだけ存在するようにします。
画像ファイル名は必ず数字の連番で始まるようにすること、などのルールを導入すれば簡単に運用できます。

prefixを使用する狙いとしては、

- 画像ファイルのパスをフルで書くのが面倒くさいので省エネしたい
- 後から画像ファイル名を変更する際に記事を修正したくない

を実現するためです。

### method

ここで指定する値については正直よくわかっていないです(すみません)。
Hugoのドキュメントを参照したところ画像に対してResize/Crop/Fill/Fitという4つのメソッドが使えるみたいなので一応全て使えるように対応してみた、という感じです。

今の私の感触としては「とりあえず画像がそれっぽく加工できていて、画像サイズが落ちていればいい」くらいにしか考えていないので深く考えないことにします。
いずれ必要な時が来たらきっと改めて調べる、ということで。

なおChatGPTに聞いてみたら以下のような答えが返ってきました

{{% notice info "Q" %}}
一般的な画像処理の用語としての、Resize、Fill、Fit、Cropの違いについて簡単に説明して
{{% /notice %}}

{{% notice tip "A" %}}

Resize（リサイズ）：画像のサイズを変更します。これは、画像のピクセルの数を増やす（アップスケーリング）か減らす（ダウンスケーリング）操作を指します。ただし、単純なリサイズではアスペクト比（幅と高さの比率）が保持されないため、画像が引き伸ばされたり圧縮されたりする可能性があります。

Fill（フィル）：指定したサイズになるように画像をリサイズしますが、このときアスペクト比を保たずに画像の全領域が指定のサイズに合わせて伸縮します。その結果、元の画像と比べて引き伸ばされたり圧縮されたりする可能性があります。

Fit（フィット）：指定したサイズになるように画像をリサイズしますが、このときアスペクト比を保ちます。つまり、画像の短い辺が指定のサイズに一致するように画像をリサイズし、長い辺は元のアスペクト比に従ってリサイズします。

Crop（クロップ）：画像から特定の領域を切り取ります。この操作は、画像の特定の部分を強調したり、不要な部分を取り除いたりするために使用されます。クロップ操作は、画像のアスペクト比を変更する可能性があります。

{{% /notice %}}

わからない(^^;)

### width & height

数値を指定します。基本的には両方とも指定しますが、Resizeの場合どちらか片方のみを指定することも可能なようです。

### anchor

CropとFillの場合に指定できる値です。

- TopLeft
- Top
- TopRight
- Left
- Center
- Right
- BottomLeft
- Bottom
- BottomRight
- Smart

のいずれかの値を指定できるようです。正確な説明はできないですがCropで言うと切り取る領域？(何て表現するのが正しいのかわからない)を指定するものです。

## 実装したコード＆解説

```html
<!-- 引数を定義 -->
{{ $prefix := .Get "prefix" }}
{{ $method := .Get "method" }}
{{ $width := .Get "width" }}
{{ $height := .Get "height" }}
{{ $anchor := .Get "anchor"}}

<!-- 引数に基づいて$sizeを設定する -->
{{ $size := "" }}
{{ if and (ne $width "") (eq $height "") }}
  {{ $size = printf "%dx webp q50" $width }}
{{ end }}
{{ if and (eq $width "") (ne $height "") }}
  {{ $size = printf "%dx webp q50" $height }}
{{ end }}
{{ if and (ne $width "") (ne $height "") }}
  {{ $size = printf "%dx%d webp q50" $width $height }}
{{ end }}
{{ if (ne $anchor "") }}
  {{ $size = printf "%s %s" $size $anchor }}
{{ end }}

<!-- 検索対象ディレクトリを取得 -->
{{ $paths := split .Page.File "/" }}
{{ $dir := delimit (first (sub (len $paths) 1) $paths) "/" }}
{{ $dir := printf "content/%s" $dir}}

<!-- リサイズ実行後の画像オブジェクトを設定する変数 -->
{{ $resized := 0 }}

<!-- 検索対象ディレクトリ内のファイルをループする -->
{{ $files := readDir $dir }}
{{ range $files }}
  <!-- 引数$prefixと先頭文字が一致するファイルの場合処理する -->
  {{ if hasPrefix .Name $prefix }}
    {{ $img := $.Page.Resources.Get .Name }}
    <!-- 引数$methodで指定された値に応じて画像処理メソッドを実行する -->
    {{ if eq $method "resize" }}
      {{ $resized = $img.Resize $size }}
    {{ end }}
    {{ if eq $method "crop" }}
      {{ $resized = $img.Crop $size }}
    {{ end }}
    {{ if eq $method "fill" }}
      {{ $resized = $img.Fill $size }}
    {{ end }}
    {{ if eq $method "fit" }}
      {{ $resized = $img.Fit $size }}
    {{ end }}
    <img src="{{ $resized.RelPermalink }}" width="{{ $resized.Width }}" height="{{ $resized.Height }}">
  {{ end }}
{{ end }}
```

やや長いですが、事前に紹介した基本の知識だけでほぼ理解できる範囲で実装できていると思います。
条件分岐のifやその他初出の関数(readDir,split,etc)については取り上げていませんでしたが、
まあ雰囲気でわかるっしょってことで省きました。許してください。

{{% notice info "MEMO" %}}
入力チェックは一切行っていません。ローカルサーバを起動して確認する過程でミスに気づけるため省きました。
{{% /notice %}}

以下、いくつか解説した方が良いポイントだけ解説しておきます。

### rangeループ周りの処理

rangeループの中で指定している`.Name`は、range $filesで個々のファイルオブジェクトが、ループ毎にコンテキストに設定されているので、
つまりファイルオブジェクツのName属性を取得している、という意味になります。

また、rangeループの中で`$.Page`という記述が出てきますが、これはrangeループのコンテキストがファイルオブジェクトになっているため、
これまでの`.Page`という記述ではページオブジェクトにアクセスできなくなるためです。その場合は`$.Page`のように最上位からたどることができます。

### 検索対象ディレクトリを取得する部分

`.Page.File`で記事ファイルのパスを取得しています。このパスの値はpost/...から始まるパスになっていました。
readDirに指定する相対パスがどこを基準にするのか、についてですが、これはプロジェクトルートからのようです。
つまりreadDirに渡す値としてはcontent/post/...となるようにする必要があるため、そのように加工をしています。

### 画像処理後の画像オブジェクト$resizedの初期値

引数$methodの内容に基づいて画像処理を行うため、if文の外でローカル変数$resizedを宣言していますが、これの初期値を0にしています。
本来であれば`nil`のような値を指定したいですが、そのような値はテンプレート言語には存在しないようです。

そのような理由でとりあえず(数値でも文字列でも)なんでもよいから0を指定しました。静的型言語的に考えると数値が設定されたりオブジェクトが設定されたりして気持ち悪いのですが、これは仕方がなさそう。

### 動作確認

実装したショートコードを実際に使用して動作を見てみます。以下の画像をサンプル画像として使用しました。

- サイズ: 1.3MB
- フォーマット: jpg
- 解像度: 1920x1280

<img src="1-woman.jpg">

#### 横幅を640pxでリサイズ

`{{</* i prefix="1" method="resize" width=640 */>}}`

- サイズ: 7KB
- フォーマット: webp
- 解像度: 640x427

{{< i prefix="1" method="resize" width=640 >}}

え、7KB！？こんなに小さくなるんですね・・・びっくり。明らかに画質は下がってますね。

#### Cropで切り抜く(Centerから500x500)

`{{</* i prefix="1" method="crop" width=500 height=500 anchor="Center" */>}}`

{{< i prefix="1" method="crop" width=500 height=500 anchor="Center" >}}

center(女性の手首あたり？)から500x500で切り抜かれている感じがするから正しく動いている・・・かな？多分。

#### Cropで切り抜く(TopRightから800x800)

`{{</* i prefix="1" method="crop" width=800 height=800 anchor="TopRight" */>}}`

{{< i prefix="1" method="crop" width=800 height=800 anchor="TopRight" >}}

なんとなくできている感じがします。おわり。
