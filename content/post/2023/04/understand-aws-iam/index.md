---
title: IAMくらいは理解しておきたいよね？AWSセキュリティの基本を押さえる
date: 2023-04-08
tags:
  - aws
  - cloud
thumbnail: aws
featureImage: ./top.jpg

description: AWSセキュリティの最低限の基本について。MFAを設定する。ルートアカウントのアクセスキーを削除する。IAMユーザやIAMロールの使い方を理解する。

summary: 業務でさんざんAWSを使ってきましたが、基本的に用意してもらった環境を使ってきただけでした。せめてAWSのセキュリティの基本くらいは押さえておきたいので改めてきちんと理解していきたいと思います。今回はIAMユーザを作成してIAMロールを割り当てる方法などを調べます。

draft: true
---

### 今回やること

これまで、個人でAWSを触るときは権限まわりの仕組みをほとんど理解しておらず何も気にせずルートアカウントを使っていました。
本記事では最低限の権限を持つIAMユーザとロールを作成し、基本的にルートアカウントを使わずに作業ができる環境を構築することを目指します。

{{%notice warning "注意事項" %}}
実務でAWSの権限管理をしたことがない素人が記事を書いております。そしてChatGPTの力をフルに借りながら執筆しています。
もちろん記事は実際に動作確認などを行なった上で掲載していますが、AWS運用のベストプラクティスに従っていない内容を含んでいる可能性があります。
IAMを利用した権限管理の基本的な作業フローを把握するためのもの、という程度の認識で見てもらえると助かります(言い訳)
{{% /notice %}}

### ルートアカウントにMFAを設定する

本題に入る前に、最初にルートアカウントにMFA(マルチファクタ認証)を設定します。
MFAはパスワードだけではなく追加の認証要素（例えば携帯電話に送られたワンタイムパスワードなど）を必要とする認証方法です。
MFAを設定することで、万が一パスワードが盗まれたとしても攻撃者がアカウントにアクセスするのを難しくします。

次の手順でMFAを設定します。

- AWSのルートアカウントで[AWSマネジメントコンソール](https://aws.amazon.com/jp/console/)にログインします
- 画面右上のアカウント名の部分をクリックしてメニューを表示し、「セキュリティ認証情報」をクリックします

{{< i prefix="1-" method="resize" height=480 >}}

- 「セキュリティ認証情報(ルートユーザ)」画面の「MFAを割り当てる」ボタンをクリックします

{{< i prefix="2-" method="resize" width=720 >}}

「MFAデバイスを選択」画面にて必要な情報を入力します。
- 「デバイス名」に任意の名前を設定します。ここではgoogle-authenticatorと設定しました。
- 「MFAデバイス」に「認証アプリケーション」を選択します。
- 「次へ」をクリックします。

{{< i prefix="3-" method="resize" height=480 >}}

デバイスの設定画面が開きます。

{{< i prefix="4-" method="resize" width=720 >}}

表示されたQRコードを読み取るための認証アプリケーションをインストールします。
- ここではChrome拡張機能の「Authenticator」を使用します

{{< i prefix="5-" method="resize" width=720 >}}

↑をインストールします。

Authenticatorを使用して先ほどのQRコードを読み取ります。
- Chromeのアドレスバーの右にあるQRコードのアイコンをクリックします。
- 表示されたウィンドウ内の赤枠で囲ったボタンをクリックします。
- 範囲選択するモードになるのでQRコードを選択し読み取ります。

{{< i prefix="6-" method="resize" height=480 >}}

QRコードの読み取りに成功すると次のダイアログが表示されます。

{{< i prefix="7-" method="resize" width=720 >}}

Authenticatorを使用してデバイスの設定画面に二つのMFAコードを入力します。
- MFAコードを入力したら「MFAを追加」ボタンをクリックします

{{< i prefix="8-" method="resize" width=720 >}}

セキュリティ認証情報(ルートユーザー)画面に戻ります。
多要素認証(MFA)一覧に新しいデバイスが追加されていればOKです。

{{< i prefix="9-" method="resize" width=1280 >}}

### ルートアカウントのアクセスキーを削除する

もしもルートアカウントにアクセスキーを設定している場合は削除します。
ルートアカウントは全てのリソースにアクセスできる特権を持つため、アクスセスキーの盗難や操作ミスによる事故が起きた時の被害を最小限にとどめるために、ルートアカウントはアクセスキーを持たないようにしましょう。

ルートアカウントにアクセスキーが設定されているとIAMダッシュボードに警告が表示されます。

{{< i prefix="10-" method="resize" width=1280 >}}

「アクセスキーを管理」から登録されているアクセスキーを削除しておきましょう。

{{< i prefix="11-" method="resize" width=1280 >}}

700日以上前からルートアカウントのアクセスキーがずっと設定されていたようです（恐ろしい)。

{{< i prefix="12-" method="resize" width=1280 >}}

アクセスキーの削除後に警告が消えていればOKです。
これでルートアカウントに対して最低限の設定をすることができました。
本記事の以降に紹介する設定を行うことで、IAMユーザ(およびロール)のみで日常的な作業を完結できるようになるため、
ルートアカウントを使用する機会を極力減らすことができるようになります。

ということでここからが本題になります。

### 作成する権限リソース(ユーザ、グループ、ロール、ポリシー)を検討する

実際の作業に入る前に、どんなリソースを作成するべきなのか洗い出しを行なっていきます。

#### ユーザ

開発者用ユーザdev-userを作成します。dev-userには直接ポリシー(権限)を設定しません。
代わりに必要なポリシーを設定したグループを作成し、dev-userはそのグループに所属します。ユーザーに直接ポリシーを設定することは可能ですが、
ユーザが増えた場合、個々のユーザに対し再度ポリシーを設定する作業が必要になります。

#### グループ

下記の二つのグループを作成します。

- developer
- developer-base

developerグループは開発対象の具体的なサービス(今回はLambdaとS3を想定)に関するポリシーを設定します。

developer-baseグループには開発全般で必要となる基本的なポリシーを設定します。具体的には、

1. MFAを設定できる
1. アクセスキーを作成できる
1. ロールの引き受けができる
1. ロールの移譲ができる
1. ロールを一覧表示できる

上記の操作を実行できるようにします。1&2は特に解説する必要がないと思いますが、3〜5については軽く触れておきます。

まず「ロールの引き受け」とはマネージメントコンソール画面での「ロールの切り替え」ボタンのクリックに相当するものです。
本番環境のリソースにアクセスする際に、一時的に本番用ロールに切り替えて作業をした経験がある方は多いと思います。英語の表現的には
ロールをAssumeする(引き受ける)、と言うようです。

次に「ロールの委譲」についてですが、文字通りの意味ですがロールを渡すことができるようになります。
これが必要になる例としてはLambda関数の作成時があります。
例えばですがLambda関数がS3にアクセスするためには、S3にアクセスするためのロールをLambdaに渡さなければなりません。
ロールを渡すためにはLambda関数を作成するユーザが「ロールを委譲」する権限を持たなければなりません。

最後に「ロールの一覧表示」ですが、こちらもLambda関数の作成時を例にします。
マネージメントコンソールからLambda関数を作成する時にLambdaに渡すロールをロール一覧の中から選択できます。
その際にロールの一覧表示をする権限が必要となります。

#### ロール

下記の二つのロールを作成します。

- admin
- lambda-exec

adminロールは開発以外の管理系の作業を行うためのロールです。ロールではなく別ユーザを用意しても構いません。
ただし、結局操作するのは自分ひとりしかいないため、今回はロールにすることにしました。
別ユーザにしてしまうとログアウトして入り直すという作業が必要になるためです。

lambda-execロールはLambda関数の作成時にLambdaに渡すロールです。S3へアクセスできる権限を持ちます。

#### ポリシー

ポリシーは「あるリソースに対する操作を許可するか拒否するか」を記述したもので以下のような形式を持つJSONです。

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "lambda:*",
            "Resource": "arn:aws:lambda:ap-northeast-1:<account-id>:function:<function-name>"
        }
    ]
}
```

作成したポリシーはユーザ/グループ/ロールに付与(アタッチ)することで機能します。

Actionには操作を指定します。上記の例ではLambdaに関連するすべての操作(lambda:*)を意味します。
この場合はLambda関数の作成/実行/削除/etcといったことを表します。そしてEffectでその操作を許可(Allow)するか拒否(Deny)するかを指定します。

ResourceにはActionで指定した操作の対象となるリソース名を指定します。Resourceに指定するリソースの種類はActionに対応するものになります。つまりActionがS3であればバケット名、LambdaであればFunction名という感じです。リソース名の記述にはARNという形式を使います。ARNは一般的に以下のような形式を持ちます：

{{<q>}}
arn:aws:<サービス名>:<リージョン名>:<アカウントID>:・・・
{{</q>}}

実際には個々のサービスによって「:」で区切られた要素の数や種類は異なります。例えばS3バケットのARNは

{{<q>}}
arn:aws:s3:::<バケット名>
{{</q>}}

となり、リージョン名やアカウントIDは指定しません。これはS3のバケット名が全世界で一意になる必要があるからです。


では実際にポリシーを記述していきます。

##### enable-mfa: MFAを設定可能にするポリシー

IAMの画面を開き、「ポリシー」を選択します。

{{< i prefix="13-" method="resize" height=300 >}}

ポリシ一の一覧画面から「ポリシーの作成」ボタンをクリックします。

{{< i prefix="14-" method="resize" width=1280 >}}

ポリシー作成画面が開きます。「JSON」をクリックしJSONエディターから直接JSONを編集します。

{{< i prefix="15-" method="resize" width=1280 >}}

JSONエディターに以下の内容のJSONを設定します。

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "iam:CreateVirtualMFADevice",
                "iam:DeleteVirtualMFADevice",
                "iam:ListVirtualMFADevices"
            ],
            "Resource": "arn:aws:iam::<account-id>:mfa/${aws:username}"
        },
        {
            "Effect": "Allow",
            "Action": [
                "iam:EnableMFADevice",
                "iam:ResyncMFADevice",
                "iam:ListMFADevices"
            ],
            "Resource": "arn:aws:iam::<account-id>:user/${aws:username}"
        },
        {
            "Effect": "Allow",
            "Action": "iam:DeactivateMFADevice",
            "Resource": "arn:aws:iam::<account-id>:user/${aws:username}",
            "Condition": {
                "BoolIfExists": {
                    "aws:MultiFactorAuthPresent": "true"
                }
            }
        }
    ]
}
```

個々のActionで記述した厳密な意味はほとんど理解していません。基本ChatGPTに書いてもらったものです。
「名前を見た感じMFAデバイスを削除したり一覧表示したりするのに必要なものだろうなー」くらいの感覚です(それで十分だろうと思ってます)。

上記JSONの`<account-id>`は、自分が使用している実際のアカウントIDで置き換えてください。JSONの編集後、JSONエディタの下部にある「次へ」をクリックし確認画面を表示します。ポリシー名を入力し、画面下部の「ポリシーの作成」ボタンをクリックします。

{{< i prefix="16-" method="resize" width=1280 >}}

以上の操作でポリシーが作成されます。

##### enable-accesskey: アクセスキーの作成を可能にする

操作手順については、先ほどと同様ですので、以降はJSONのみを掲載します。

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "iam:CreateAccessKey",
                "iam:DeleteAccessKey",
                "iam:ListAccessKeys",
                "iam:UpdateAccessKey"
            ],
            "Resource": "arn:aws:iam::<account-id>:user/${aws:username}"
        }
    ]
}
```

##### enable-role-assume: ロールの引き受けを可能にする

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::<account-id>:role/admin"
        }
    ]
}
```

{{% notice info "MEMO" %}}
ロール名にワイルドカード(*)を指定すると、権限を渡しすぎている旨のワーニングが出ます。
{{% /notice %}}
