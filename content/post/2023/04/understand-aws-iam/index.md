---
title: IAMくらいは理解しておきたいよね？AWSセキュリティの基本を押さえる
date: 2023-04-08
tags:
  - aws
  - cloud
thumbnail: aws
featureImage: ./top.jpg

description: AWSセキュリティの最低限の基本について。MFAを設定する。ルートアカウントのアクセスキーを削除する。IAMユーザやIAMロールの使い方を理解する。

summary: これまで業務でさんざんAWSを使ってきたのですが、基本的に用意してもらった環境を使ってきただけでした。せめてAWSのセキュリティの基本くらいは押さえておきたいので改めてきちんと理解していきたいと思います。今回はIAMユーザを作成してIAMロールを割り当てる方法などを調べます。

draft: true
---

### 今回やりたいこと

自宅でAWSを触るときは権限まわりの仕組みをほとんど理解していなかったので何も気にせずルートアカウントを使っていました。
この危険な状態から脱すること、操作に必要な最低限の権限を持つIAMユーザとロールを使用して安全に運用できるようにします。

### ルートアカウントにMFAを設定する

本題に入る前に、最初にAWSのルートアカウントにMFA(マルチファクタ認証)を設定しておきましょう。MFAはパスワードだけではなく追加の認証要素（例えば携帯電話に送られたワンタイムパスワードなど）を必要とする認証方法です。これにより、もしパスワードが盗まれたとしても攻撃者がアカウントにアクセスするのを難しくします。

次の手順でMFAを設定します。

- AWSのルートアカウントで[AWSマネジメントコンソール](https://aws.amazon.com/jp/console/)にログインします
- 画面右上のアカウント名の部分をクリックしてメニューを表示し、「セキュリティ認証情報」をクリックします

{{< i prefix="1-" method="resize" height=480 >}}

- 「セキュリティ認証情報(ルートユーザ)」画面の「MFAを割り当てる」ボタンをクリックします

{{< i prefix="2-" method="resize" width=720 >}}

「MFAデバイスを選択」画面にて必要な情報を入力します
- 「デバイス名」に任意の名前を設定します。ここではgoogle-authenticatorと設定しました
- 「MFAデバイス」に「認証アプリケーション」を選択します
- 「次へ」をクリックします

{{< i prefix="3-" method="resize" height=480 >}}

デバイスの設定画面が開きます

{{< i prefix="4-" method="resize" width=720 >}}

表示されたQRコードを読み取るための認証アプリケーションをインストールします
- ここではChrome拡張機能の「Authenticator」を使用します

{{< i prefix="5-" method="resize" width=720 >}}

↑をインストールします

Authenticatorを使用して先ほどのQRコードを読み取ります
- アドレスバーの右にあるQRコードのアイコンをクリックします
- 表示されたウィンドウ内の赤枠で囲ったボタンをクリックします
- 範囲選択するモードになるのでQRコードを選択し読み取ります

{{< i prefix="6-" method="resize" height=480 >}}

QRコードの読み取りに成功すると次のダイアログが表示されます

{{< i prefix="7-" method="resize" width=720 >}}

Authenticatorを使用して先ほどのデバイスの設定画面に二つのMFAコードを入力します。
- MFAコードを入力してから「MFAを追加」ボタンをクリックします

{{< i prefix="8-" method="resize" width=720 >}}

多要素認証(MFA)一覧に新しいデバイスが追加されていればOKです

{{< i prefix="9-" method="resize" width=1280 >}}

### ルートアカウントのアクセスキーを削除する

もしもルートアカウントにアクセスキーを設定している場合は削除するようにしましょう。
ルートアカウントは全てのリソースにアクセスできてしまうためアクスセスキーの盗難や操作ミスによる事故を
考慮すると、ルートアカウントへのアクセスキーの設定は非推奨です。

ルートアカウントへのアクセスキーが設定されているとIAMのダッシュボード画面に警告が表示されます。

{{< i prefix="10-" method="resize" width=1280 >}}

「アクセスキーを管理」から登録されているアクセスキーを削除しておきましょう。

{{< i prefix="11-" method="resize" width=1280 >}}

700日以上前からルートアカウントのアクセスキーがずっと設定されていたようです。
今考えると恐ろしいですね・・・。

{{< i prefix="12-" method="resize" width=1280 >}}

アクセスキーの削除後は警告が消えていることが確認できました。
これでルートアカウントに関する必要最低限の設定をすることができました。
今後はルートアカウントはどうしても必要な時のみ使い、IAMユーザを使うようにします。

ということでこれからが本題になります。以降でIAMユーザやIAMロールの設定を行なっていきます。

### 作成するリソースを検討する

#### ユーザ

開発者用ユーザを作成します。名前は任意でOKですが、ここではdev-userとします。dev-userには直接ポリシー(権限)を設定しません。
代わりに必要なポリシーを設定したグループを作成し、そのグループに所属させます。ユーザーに直接ポリシーを設定することも可能ですが、
そうしない理由は開発用ユーザーを追加で作成する際に個別に設定するのが面倒になるためです。

#### グループ

developerグループを作成します。dev-userが所属するグループとなります。developerグループは開発に必要となる権限を設定します。
今回はLambdaとS3を使った開発をする想定とします。さらに、

- アクセスキーを作成できること
- MFAを設定できること
- ロールの引き受けができること
- ロールの移譲ができること

を追加します。上二つは特に問題なく理解してもらえると思いますが、下二つについては簡単に解説をしておきます。

##### ロールの引き受けとは

##### ロールの移譲とは

#### ロール

二つのロールを作成します。一つ目は管理業務用のロールです。


### ポリシーを作成する

ポリシーは以下のような形式を持つJSONです。

上記の例ではS3に関連するすべての操作(s3:*)を許可(Allow)するものになります。
ResourceにはActionで指定した操作(例えばバケットを作成する、とかLambdaを実行するなどがあります)の対象となるリソースを指定します。
Resourceに指定するリソースの種類はActionに対応するものとなります。つまりS3であればバケット名を指定し、Lambdaであれば
Function名となります。

Resourceの記述にはARNというリソースを識別するための形式を使います。ARNの形式は以下の通りです。

では実際のポリシーを記述しましょう。次のように作成します。

```

```


IAMユーザを作成する前に先にIAMグループを作成し権限を設定します。
そしてIAMユーザを作成したグループに所属させます。
正直なところ操作するのは私一人だけなのでIAMユーザに直接権限を設定して構わないような気がしますが、
ユーザが今後増えないとは言い切れないので基本的にはグループに権限を設定していく方針とします。
